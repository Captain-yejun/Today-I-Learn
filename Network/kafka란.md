# kafka란 무엇인가?
- kafka는 대규모 실시간 데이터 스트리밍을 처리하는 데 사용되는 분산 이벤트 스트리밍 플랫폼이다.

- 여기서 분산 이벤트라는 말은 여러 대의 서버(노드)에 분산되어 저장된 이벤트(데이터) 를 말한다.

- 이벤트 스트리밍은 대량의 이벤트(데이터)를 실시간으로 처리하는 방식을 의미한다.

- 즉, 이 두 내용을 연결 시키면 분산 되어 있는 이벤트(데이터)들을 실시간으로 처리하는 플랫폼이라는 뜻이 된다.
<br>

![image](https://github.com/user-attachments/assets/fca66b73-35f2-443c-a050-28944f9e0ed1)
> kafka가 중간에서 데이터들을 처리한다.
<br>
<hr>
<br>

## ✔️ 탄생 배경
- 비즈니스 소셜 네트워크 서비스인 링크드인 (linked-in) 에서 개발하였는데,
다음은 카프카 개발 전 링크드인의 데이터 처리 시스템을 먼저 확인해보자.
<br>

![image](https://github.com/user-attachments/assets/18cda2bf-4737-4ff1-bcb5-258e76ab3e5e)
> 각 애플리케이션과 DB가 end-to-end 로 연결되어 있고(각 파이프라인이 파편화 되어있음)<br>
요구사항이 늘어남에 따라 데이터 시스템 복잡도가 높아지면서 다음과 같은 문제가 발생하게 되었다.
<br>

### 시스템 복잡도 증가
- 통합된 전송 영역이 없어 데이터 흐름을 파악하기 어렵고, 시스템 관리가 어려움

- 특정 부분에서 장애 발생 시 조치 시간 증가 (=> 연결 되어있는 애플리케이션들을 모두 확인해야 하기 때문에)

- HW 교체 / SW 업그레이드 시 관리포인트가 늘어나고, 작업시간 증가 (=> 연결된 애플리케이션에 side effect 가 없는지 확인해야 함)
<br>

### 데이터 파이프라인 관리의 어려움
- 각 애플리케이션과 데이터 시스템 간의 별도의 파이프라인 존재하고, 파이프라인 마다 데이터 포맷과 처리 방식이 다름

- 새로운 파이프라인 확장이 어려워지면서, 확장성 및 유연성이 떨어짐

- 또한 데이터 불일치 가능성이 있어 신뢰도 감소
<br>

**이러한 문제를 해결하기 위해 새로운 시스템의 개발 필요성이 높아짐**
> 모든 이벤트/데이터의 흐름을 중앙에서 관리하는 카프카가 개발됨
<br>

![image](https://github.com/user-attachments/assets/e8794c3f-8a1e-4715-ab31-ec3cbb130fac)
> 링크드인의 카프카 적용 전 - 카프카 적용 후 아키텍처
<br>

- 위 그림의 왼쪽은 링크드인에서 개발한 카프카가 등장하기전의 아키텍처 모습니다.

- 각 데이터 저장소들이 도착지점까지 모든 시스템을 거치는 End - To - End 연결로 매우 복잡한 것을 볼 수 있다.

- 하지만 카프카가 적용된 오른쪽 그림을 보면 모든 이벤트와 데이터를 카프카가 처리하는 것을 볼 수 있다.
<br>

### kafka 적용 후
- 모든 이벤트/데이터의 흐름을 중앙에서 관리할 수 있게 됨

- 새로운 서비스/시스템이 추가되도 카프카가 제공하는 표준 포맷으로 연결하면 되므로 확장성과 신뢰성이 증가

- 개발자는 각 서비스간의 연결이 아닌, 서비스들의 비즈니스 로직에 집중 가능
<br>
<hr>
<br>

## ✔️ 분산이벤트 실시간 관리 방법
- Pub / Sub 모델의 메세지 큐 형태로 동작한다.

### 메세지 큐 (Message Queue, MQ)
- 카프카를 이해하기 위해서는 카프카의 핵심 개념인 메세지 큐에 대한 이해가 필요하다.
 
- 메세지 큐는 "메시지 지향 미들웨어 (MOM : 서로 다른 시스템, 애플리케이션, 서비스 간에 메시지를 교환하는 방식)"를 구현한 시스템이다.
<br>

![image](https://github.com/user-attachments/assets/88c70936-1887-4441-8b7a-c1ce6e643d5e)
<br>

- 메시지 큐를 사용하면 메세지를 보낸 사람(발행자)와 메세지를 받는 사람(수신자)가 서로를 직접 알 지 못해도 전송, 수신이 가능하다.<br>
  - (비동기 : 느슨한 결합)
<br>

- 바로 발행자와 수신자 사이에 메시지 큐가 이를 중개하고 있기 때문이다.
<br>

### 메세지 큐의 장점
- 수신자의 서비스에서 장애가 발생하더라도 발행자로 인해 발행된 메세지는 이미 메시지 큐에 남아 있기 때문에 수신자에게 메세지 전달을 보장할 수 있다.

- 발행자와 수신자가 서로 의존하지 않고 독립적이기 때문에 확장하는데 문제가 없다.

- 메세지 큐라는 중개소가 있기 때문에 발행자와 수신자가 서로의 요청과 응답을 기다리지 않고 큐에 담아 비동기로 통신할 수 있다.
<br>

### 메세지 큐 종류
**➡️ Point to Point (P2P)**
- 한 명의 발행자의 메세지는 한 명의 컨슈머에 의해 소비되는 방식으로 즉, 1 : 1 메시지 전송 방식
<br>

**➡️ Publish/Subscribe (Pub / Sub)**
- 발행자가 특정 Topic(토픽)에 메시지를 보내면, 해당 Topic을 구독한 여러 수신자가 해당 메시지를 받는 방식

![image](https://github.com/user-attachments/assets/655d388a-6c6d-4a93-9886-e642c13bb784)
> kafka는 Pub / Sub 방식만 지원
<br>
<hr>
<br>

## ✔️ kafka 용어 정리
![image](https://github.com/user-attachments/assets/829d0ee8-5d6d-4518-9a07-afc380d46a6e)
> 출처 : https://www.linkedin.com/pulse/how-deploy-kafka-zookeeper-cluster-linux-based-operating-tiwari
<br>

**➡️ 카프카 클러스터 (kafka cluster)**
- 브로커들의 모임으로 확장성과 고가용성을 위해 Broker들이 클러스터로 구성되어 있다.
<br>

**➡️ 브로커 (Broker)**
 - 각각의 Kafka 서버를 말한다.
 
 - 프로듀서로 부터 메세지를 전달받아 토픽에 저장하고 컨슈머에 저장한다. (한나의 브로커는 여러개의 토픽을 가질 수 있다.)
<br>

**➡️ 주키퍼 (zookeeper)**
- Kafka 클러스터 상태와 정보 등을 관리하는 역할을 한다. (Kafka를 실행 시키기 위해선 Zookeeper도 같이 실행해야함)
<br>

**➡️ 프로듀서 (Producer)**
- 메시지를 발행하는 주체이다.

- 메시지 발행 시 특정 토픽을 정하여 발행한다.
<br>
 
**➡️ 컨슈머 (Consumer)**
- 메시지를 소비, 수신하는 주체이다. 

- 특정 토픽을 구독하여 메시지를 전달 받는다.
<br>

![image](https://github.com/user-attachments/assets/f6266233-3fe3-4686-8be0-cd79f1f2a834)
<br>

**➡️ 컨슈머 그룹 (Consumer Group)**
- 컨슈머 그룹은 하나 이상의 컨슈머가 모여 구성된 그룹이다.

- 같은 컨슈머 그룹 내에서는 각 파티션에 대한 메시지 처리가 한 컨슈머에게만 할당된다. (즉, 각 파티션의 메시지는 한 번만 처리).

- 쉽게 얘기하면 "책"이라는 토픽에 파티션이 1, 2가 있고 그룹 G에 컨슈머 a, b가 있다면 a는 1, b는 2 파티션에서 메시지를 받는 것이다.

- 즉, 한 그룹안에 있는 여러 컨슈머들이 서로 다른 파티션에서 동일한 토픽을 동시에 소비하는 것.
<br>

![image](https://github.com/user-attachments/assets/500310b9-ef8b-468b-8079-fec51d6c0ea3)
<br>

**➡️ 토픽 (Topic)**
- 메시지를 구분하는 단위로 프로듀서로 부터 전송된 데이터는 토픽이름으로 구별된다.
<br>

**➡️ 파티션 (partition)**
- 하나의 토픽은 하나 이상의 파티션으로 나눠진다.

- 즉, 동일한 토픽이 여러 파티션에 나눠서 저장되는 것이다.
<br>

**➡️ 오프셋 (offset)**
- 파티션 내에서 메시지의 위치(식별자)를 나타낸다. 

- 책의 페이지 번호를 알면 해당 페이지로 바로 이동할 수 있듯이, 오프셋 값을 알면 해당 메시지로 바로 접근할 수 있다.
<br>
<hr>
<br>

## ✔️ Pub / Sub 모델별 차이
| 항목        | Kafka                                                                 | RabbitMQ                                                               | Redis Pub/Sub                                         |
|-------------|----------------------------------------------------------------------|------------------------------------------------------------------------|------------------------------------------------------|
| **데이터 유지** | 데이터를 지속적으로 디스크에 저장하며, TTL 설정으로 오래된 데이터 삭제 가능. Consumer가 어디까지 읽었는지 추적 가능.  | 메시지는 메모리와 디스크에 저장, 기본적으로 메시지는 Consumer가 처리 후 삭제됨.        | 기본적으로 메모리 기반, 데이터 유실 위험 있음. 영속성을 위해 AOP, RDB 추가 설정 필요. |
| **확장성**   | Topic의 Partition을 통해 확장성 제공, 분산 처리 가능.                                     | Queue를 통해 확장성 제공. Kafka만큼의 높은 병렬처리 능력은 부족.                      | Pub/Sub 모델에서는 병렬 처리 및 분산 처리 방식이 제한적.              |
| **우선순위**   | 변경 불가능하지만, 한 파티션 내에서는 시간 순서 보장.                                     | Priority queue 지원으로 우선순위에 따라 처리 가능.                                 | -                                                    |
| **장점**     | - 이벤트가 전달되어도 삭제되지 않고 디스크에 저장. <br> - 고성능, 고가용성, 분산처리에 효과적. <br> - Producer 중심으로 대량의 데이터 병렬 처리 가능.  | - Direct, Fanout, Topic, Headers 라우팅 옵션 제공. <br> - 관리 UI 제공. <br> - Broker 중심의 메시지 전달 보장. <br> - 플러그인으로 확장성 뛰어남. | - 인메모리로 빈번하고 속도가 중요한 작업에 적합.                  |
| **단점**     | 범용 메시지 시스템에서 제공하는 다양한 기능이 부족.                                        | - Kafka보다 느림. <br> - 대용량 데이터 처리에 부적합.                               | 이벤트 도착 보장 불가.                                      |
| **사용 사례** | 대용량 실시간 스트림 데이터 처리 및 분석에 적합.                                          | 관리적 측면이나 다양한 기능 구현이 필요한 서비스 구축에 적합.                              | 캐싱, 세션 관리 등 인메모리 스토어나 경량의 실시간 Pub/Sub 시스템에 적합.  |
<br>
<hr>
<br>

**Reference**<br>

[Dragony : [Apache Kafka] 카프카란 무엇인가?](https://velog.io/@holicme7/Apache-Kafka-%EC%B9%B4%ED%94%84%EC%B9%B4%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%B8%EA%B0%80)<br>
[leediz : Apache Kafka란](https://leediz.tistory.com/2)<br>
[< Hyun / Log > : [Kafka] 카프카란 ? 주요개념 정리 및 Pub/Sub 모델 비교](https://hstory0208.tistory.com/entry/Kafka-%EC%B9%B4%ED%94%84%EC%B9%B4%EB%9E%80-%EC%A3%BC%EC%9A%94%EA%B0%9C%EB%85%90-%EC%A0%95%EB%A6%AC-%EB%B0%8F-PubSub-%EB%AA%A8%EB%8D%B8-%EB%B9%84%EA%B5%90)
